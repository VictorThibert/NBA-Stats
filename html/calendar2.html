<!DOCTYPE html>
<meta charset="utf-8">
<style type="text/css">
  .month {display: inline-block;}


body {
  font: 10px sans-serif;
  shape-rendering: crispEdges;
}

.day {
  fill: #f5f5dc;
}

.fillerday {
  fill: #EEE;
}




</style>
<body>

<div id = "calendar">
  <div class = "month" id = "m6"></div>
  <div class = "month" id = "m7"></div>
  <div class = "month" id = "m8"></div>
  <div class = "month" id = "m9"></div>
  <div class = "month" id = "m10"></div>
  <div class = "month" id = "m11"></div>
  <div class = "month" id = "m0"></div>
  <div class = "month" id = "m1"></div>
  <div class = "month" id = "m2"></div>
  <div class = "month" id = "m3"></div>
  <div class = "month" id = "m4"></div>
  <div class = "month" id = "m5"></div>
</div>

<script src="../scripts/libs/d3/d3.v3.min.js"></script>

<script>

renderCalendar("6", 2014, 2015); //months are zero indexed
// renderCalendar("7", 2014, 2015);
// renderCalendar("8", 2014, 2015);
// renderCalendar("9", 2014, 2015);
// renderCalendar("10", 2014, 2015);
// renderCalendar("11", 2014, 2015);
// renderCalendar("0", 2015, 2016);
// renderCalendar("1", 2015, 2016);
// renderCalendar("2", 2015, 2016);
// renderCalendar("3", 2015, 2016);
// renderCalendar("4", 2015, 2016);
// renderCalendar("5", 2015, 2016);

function renderCalendar(container, year1, year2){

  var lastDay = new Date(year1, parseInt(container) + 12, 0);
  var firstDay = new Date(year1, parseInt(container), 1);
  var weekOfLastDay = d3.time.weekOfYear(lastDay) - d3.time.weekOfYear(firstDay);

  var width = 2110;
  var height = 136;
  var cellSize = 17; // cell size
  var padding = 0;
  var monthSpace = 0;

  var percent = d3.format(".1%"),
      format = d3.time.format("%Y-%m-%d");

  var color = d3.scale.linear()
    .domain([-60,0,60])
    .range(["red", "beige", "green"]);

  var svg = d3.select("body").selectAll("svg")
      .data(d3.range(year1, year2))
      .enter().append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("class", "RdYlGn")
      .append("g")
      .attr("transform", "translate(" + 0 + "," + (height - cellSize * 7 - 1) + ")");

  svg.append("text")
      .attr("transform", "translate(-6," + cellSize * 3.5 + ")rotate(-90)")
      .style("text-anchor", "middle")
      .text(function(d) { return d; });

  var rect = svg.selectAll(".day")
      .data(function(d) { 
        return d3.time.days(new Date(d, parseInt(container), 1), new Date(d, parseInt(container) + 12, 1)); }) // + 12 for twelve months
    .enter().append("rect")
      .attr("class", "day")
      .attr("width", cellSize - padding)
      .attr("height", function(d){
        if(d.getDate() == 1 && d.getDay() != 0) {
          return cellSize - padding - monthSpace / 2 - monthSpace / 3;
        }
        return cellSize - padding;
      })
      .attr("x", function(d) { //if clause for special case where end of year is the same week as beginning of year. Modulo 53 in that case
        if ( d.getMonth()  == parseInt(container) - 1 && (d3.time.weekOfYear(d) - d3.time.weekOfYear(d3.time.day(new Date(year1, parseInt(container), 1))) + 52) % 52 == 0) {
    
          return ((d3.time.weekOfYear(d) - d3.time.weekOfYear(d3.time.day(new Date(year1, parseInt(container), 1))) + 52) % 53 * cellSize) + 
        (d.getMonth()  + 6) % 12 * monthSpace; //

        }
        return ((d3.time.weekOfYear(d) - d3.time.weekOfYear(d3.time.day(new Date(year1, parseInt(container), 1))) + 52) % 52 * cellSize) + 
        (d.getMonth()  + 6) % 12 * monthSpace; //month spacing
        }) 
      .attr("y", function(d) { 
        if(d.getDate() == 1 && d.getDay() != 0) {
          return d.getDay() * cellSize + monthSpace + 1.5;
        }

        return d.getDay() * cellSize + 1.5; })
      .datum(format);

      var temp = [];


  rect.append("title")
      .text(function(d) { return d; });

  var plusminus = 0;
  var count = 0;

  d3.json("http://cherrypicker.io/php/getgamedata.php?teamID=1610612752", function(error, raw){
    if (error){
      throw error;
    }

    if (count == 0){
      var firstGame = raw[0].GAME_DATE_EST;
      firstGame = new Date(firstGame.slice(0,4), firstGame.slice(4,6) - 1, firstGame.slice(6,8));
      var lastGame = raw[raw.length - 1].GAME_DATE_EST;
      lastGame = new Date(lastGame.slice(0,4), lastGame.slice(4,6) - 1, lastGame.slice(6,8));
      
      var regularSeason = d3.time.days(firstGame, lastGame);


      function merge_options(obj1,obj2){
          var obj3 = {};
          for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
          for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
          return obj3;
      }

      var data2= {};

      for (var i = 0; i < regularSeason.length; i += 1) {
        var x = regularSeason[i];
        x = new Date(x);
  
        key = x.getFullYear() + "-" + ("0" + (x.getMonth() + 1)).slice(-2) + "-" + ("0" + x.getDate()).slice(-2);
        data2[key] = 0;
      }

      var data = d3.nest()
        .key(function(d) { 
          var e = d.GAME_DATE_EST; 
          return e.slice(0,4) + "-" + e.slice(4,6) + "-" + e.slice(6,8);})
        .rollup(function(d,i) {/*plusminus += parseInt(d[0].WIN * 2 - 1); */return parseInt(d[0].WIN * 2 - 1);})
        .map(raw);


      var data3 = merge_options(data2, data);

      var corresponding = [0];

      cCount = 1;
      for (var x in data3) {
        var value = data3[x];
        corresponding[cCount] =  corresponding[cCount - 1] +parseInt(value);
        cCount += 1;
      
        data3[x] = corresponding[cCount -1];
      }


      rect.filter(function(d) { return d in data3; }) //returns the days in the div for that month
        .style("fill", function(d){return color(data3[d]); })
       .select("title")
        .text(function(d) { return d + ": " + data3[d];}); 

        count +=1;

      
    }

    
  });

 
  d3.select(self.frameElement).style("height", "2910px");
}

</script>